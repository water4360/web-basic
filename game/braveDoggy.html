<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>하리의 산책</title>
  <!-- <script
      src="https://code.jquery.com/jquery-3.6.4.js"
      integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
      crossorigin="anonymous"></script> -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link rel="stylesheet" href="style.css" />

  <script>
    let container = $("#container");
    let countdown = $("#countdown");


    let hari;
    let bunny;
    let food;
    let goose;
    // let score = $("#score");

    //모든 오브젝트가 준비되면 변수할당&실행
    $(document).ready(function () {
      const startButton = $("#startButton");
      let contents = $("#contents");

      hari = $("#hari");
      bunny = $("#rabbit");
      // food = $(".food");
      food = $(".food");
      goose = $(".toAvoid");
      countdown = $("#countdown");

      //초기화면 세팅
      // moveBackground();
      contents.hide();//hari, food, goose, score, countdown 포함
      countdown.hide();

      //배경화면 움직이기
      // function moveBackground() {
      let position = 0;
      setInterval(function () {
        $("#container").css("background-position", position-- + "px");
      }, 20);
      // }

      ////////////게임 시작 버튼을 누르면 안내메세지&버튼 사라지고
      startButton.click(function () {

        $("#startScreen").hide();
        startButton.hide();
        countStart();

      }); //click 함수 끝



      ///////////countstart 끝나면 gameStart
      function countStart() {
        // 3부터 countdown
        countdown.show();
        let count = 3;
        countdown.text(count);

        setInterval(() => {
          count--;
          countdown.text(count);
          if (count === 0) {
            clearInterval(this)
            // alert("게임이 시작되었습니다.");
            countdown.hide();
            gameStart();
          }
        }, 1000);
      }

      //게임 시작(임시 확인용)
      gameStart();
      $("#startScreen").hide();


      ///////////////게임 시작시 모든 함수 실행
      function gameStart() {


        contents.show();



        setKeyboardEvent();
        objFood();
        objToAvoid();

        checkGameOver();
        checkGameClear();

        $('#gameover_screen').hide();
      }

      /////////////하리(캐릭터) 따라다니기
      function followHari() {
        let whereHari = hari.position();
        bunny.css({
          left: whereHari.left + -20 + "px",
          top: whereHari.top + 70 + "px",
        });
      }
      setInterval(followHari, 1000 / 60);


      //최소~최대값 랜덤함수 구하기
      function getRandomNumber(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      //여기서부터 score는 다시 넘버
      let score = 0;

      /////////////////////////먹어야 할 오브젝트
      function objFood() {
        // const food = $("#yammy");
        // 속도 조절
        const speed = getRandomNumber(2000, 3000);

        
        // 음식이 우측으로부터 800px까지 이동
        food.animate({ right: "800px" }, speed, "linear", function () {
          // 음식 리필
          food.css("right", "-50px");
          objFood();
        });

        //먹으면 점수 증가
        setInterval(function () {
          if (isColliding(hari[0], food[0])) {
            score += 100;
            updateScore(score);
            food.stop();
            food.css("right", "-50px");
            objFood();
            // hari.stop();
          }
        }, 1000 / 60);

      }

      //////////////////////피해야할 오브젝트
      function objToAvoid() {
        // 속도 조절
        const speed = getRandomNumber(4000, 5000);

        // 장애물이 오른쪽에서 왼쪽으로
        goose.animate({ right: "800px" }, speed, "linear", function () {
          // 구스 리셋
          goose.css("right", "-300px");
          objToAvoid();
        });

        let collided = false; //충돌 여부 확인
        let hasCollidedBefore = false;

        setInterval(function () {
          if (isColliding(hari[0], goose[0])) {
            collided = true;

            //첫 충돌일때만 점수 감소
            if (!hasCollidedBefore) {
              score -= 100;
              updateScore(score);
              hasCollidedBefore = true;
            }
            collided = false;
          }
        }, 1000 / 60);
      }






      //점수 반영 + 색변경
      function updateScore(score) {
        let currentScore = $("#score");
        currentScore.text(score).append("점");

        if (parseInt(currentScore.text()) < 0) {
          currentScore.css("color", "red");
        } else {
          currentScore.css("color", "aliceblue");
        }
      }






      //충돌 감지
      //하리전용
      function isColliding(object1, object2) {
        // const char = object1.getBoundingClientRect();
        const char = {
          //230513 22:03 1차 수정
          bottom: object1.getBoundingClientRect().bottom,
          top: object1.getBoundingClientRect().top + 40,
          right: object1.getBoundingClientRect().right - 20,
          left: object1.getBoundingClientRect().left + 50,
        };

        const obj = object2.getBoundingClientRect();

        return !(
          char.bottom < obj.top ||
          char.top > obj.bottom ||
          char.right < obj.left ||
          char.left > obj.right
        );
      }

      ///////////////게임클리어 조건
      function checkGameClear() {
        setInterval(function () {
          // console.log(score);
          // console.log(score > 100);
          if (score > 300) {
            // alert("게임 클리어!");
            // food.fadeOut(3000)
            // toAvoid.fadeOut;

            //하리 잠든 사진, 산책 끝!
            // $("#gameclear_screen").show();
            // contents.css.transition = "all 2s";
            // alert("산책 완료!");
            clearInterval(this);
          }
        }, 1000 / 60);
      }

      /////////////////////게임오버 조건
      function checkGameOver() {
        const isGameOver = false;
        setInterval(function () {
          if (score <= -500) {
            hari.stop();
            food.stop();
            goose.stop();
            $("#gameover_screen").show();
            //확인용
            $('#startScreen').hide();
            isGameOver = true;
          }
        });
      }

      // 점프 중인지?
      let isJumping = false;

      // 키보드 이벤트 정의
      function setKeyboardEvent() {
        $("html").keydown(function (e) {
          switch (e.key) {
            case "ArrowLeft":
            case "A":
            case "a":
              moveLeft();
              break;
            case "ArrowRight":
            case "D":
            case "d":
              moveRight();
              break;
            case " ": //spacebar
              if (!isJumping) {
                jump();
              }
              break;
            // spacebar 입력시 친구호출ㅋㅋ
            case "F":
            case "f":
              callBunny();
              break;
            case "R":
            case "r":
              retry();
              break;
          }
          console.log(e.key);
        });

        function moveLeft() {
          hari.animate({ left: "-=10px" }, 0);
          if (hari.position().left < 0) {
            hari.animate({ left: "+=10px" }, 0);
          }
          //왼쪽벽에 닿는지
          const hariLeftMargin = hari.position().left;
          if (hariLeftMargin < 30) {
            hari.animate({ left: "+=10px" }, 0);
          }
        }
        function moveRight() {
          hari.animate({ left: "+=10px" }, 0);
          //1번
          if (hari.position().left > 450) {
            hari.animate({ left: "-=10px" }, 0);
          }
          //오른쪽 한계
          const hariRightMargin = hari.position().left;
          if (hariRightMargin > container.width() - hari.width()) {
            hari.animate({ left: "-=10px" }, 0);
          }
        }
        function jump() {
          isJumping = true;
          hari
            .animate({ bottom: "+=100px" }, 300)
            .animate({ bottom: "-=100px" }, 1200, function () {
              isJumping = false;
            }); //합쳐줬음
        }




        // 필살기, 친구 부르기
        function callBunny() {
          //bunny = $("#rabbit"); 이건 안되고...
          let bunny = $("#rabbit");
          const initialPosition = bunny.position().left;

          bunny.animate(
            { left: "+=300px" },
            //숫자 낮으면 빠르고, 높으면 느려짐
            300,
            "linear",
            function () {
              bunny.css("transform", "scaleX(-1)");
              bunny.animate(
                { left: initialPosition + "px" },
                1000,
                "linear",
                function () {
                  bunny.css("transform", "none");
                }
              )
            })
            killGoose();
        }
        // const fox = document.querySelector("#fox");
        // const bunny = document.querySelector("#rabbit");
        // const goose = document.querySelector("#goose");

        //토끼의 거위잡기
        function killGoose() {
          const bunnyRect = bunny.getBoundingClientRect();
          const gooseRect = goose.getBoundingClientRect();

          if (bunnyRect.x + bunnyRect.width > gooseRect.x) {
            // alert("거위를 잡았다!");
            goose.css.hide();
          }
        }

        setInterval(killGoose, 1000 / 60);
      }
      // });




      ///////////다시하기
      function retry() {
        $("#gameover_screen").hide();
        count = 3;
        // contents.position(defaultPosition);
        // gameStart();

      }






    }); //ready 함수 끝






    // $('#gameover_screen input[type="button"]').click(function () {
    // $('#retryButton').click(function () {
    //   $("#gameover_screen").hide(); // 게임 오버 화면 숨김
    //   gameStart(); // 게임 재시작
    // });


  </script>
</head>









<body>
  <!-- <span id="title">하리의 산책</span> -->
  <!-- <span id="title"
      >하리가 미친 거위를 피해 <br />
      안전하게 산책을 마치고 <br />돌아갈 수 있도록 도와주세요!</span
    > -->
  <div id="container">
    <div id="intro">
      <div id="startScreen">
        <span id="titleName">하리의 평화로운 산책</span>
        <span id="titleEngName">Hari's peaceful walk</span>

        <span id="titleText">
          목표점수 1000점을 모아서 <br />
          하리🐕가 이상한 거위🔪를 피해 <br />
          집으로 돌아갈 수 있도록 도와주세요! <br />
        </span>
        <button id="startButton" onclick="clickButton()">시작하기</button>
      </div>
      <div id="countdown">3</div>
    </div>


    <div id="contents">
      <div>
        <img id="hari" src="src/walking-hari.gif" alt="" />
        <img class="friend" id="fox" src="src/fox.gif" alt="" />
        <img class="friend" id="rabbit" src="src/rabbit.gif" alt="" />
      </div>

      <!-- <span class="food" id="yammy">하리야💕</span> -->
      <img class="food" id="bone" src="src/bone.png" alt="" />
      <img class="toAvoid" id="goose" src="src/goose.gif" alt="" />
      <img id="star" src="src/star.gif" alt="">
      <div id="score">000점</div>
    </div>


    <div id="gameover_screen">
      <span id="gameover_msg">
        <산책 실패😥><br>💡게임을 클리어하면 진짜 하리를 만날 수 있어요!
      </span> <br>
      <button id="retryButton" onclick="window.location.reload();">다시 도전하기[R]</button>
      <!-- <button id="retryButton" onclick="$().gameStart()">다시 도전하기[R]</button> -->
    </div>

    <div id="guide">
      이동 : A◀ ▶D&nbsp&nbsp&nbsp점프 : [spacebar]&nbsp&nbsp&nbsp🐇 : F
    </div>
  </div>
</body>

</html>